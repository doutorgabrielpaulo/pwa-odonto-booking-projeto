{% extends "layout.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odonto Booking - Alugar Salas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden { opacity: 0; visibility: hidden; }
    </style>
</head>
<body class="p-6">
    <h1 class="text-3xl font-bold text-center mb-8">Alugar Salas</h1>

    <div id="calendar-section" class="mb-8">
        </div>

    <div class="bg-white rounded-lg shadow-md p-4 mb-4">
        <h2 class="text-xl font-bold">Sala 112</h2>
        <p class="text-gray-600 mb-4">Descrição da sala.</p>
        <div class="flex flex-wrap gap-2">
            <button class="time-slot px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition" data-room-id="sala_112" data-start-time="09:00" data-end-time="11:30" onclick="showConfirmationModal('Sala 112', '09:00', 'sala_112', '2025-08-30')">09:00 - 11:30</button>
            <button class="time-slot px-3 py-1 bg-red-500 text-white rounded">12:00 - 14:30</button>
        </div>
    </div>

    <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div id="step-1">
                <h3 class="text-xl font-bold mb-4">Confirmação de Reserva</h3>
                <p class="mb-4">Você confirma a reserva da <span id="room-name"></span> para o horário de <span id="time-slot"></span>?</p>
                <div class="flex justify-end gap-2">
                    <button id="cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Confirmar</button>
                </div>
            </div>

            <div id="tutorial-step" class="hidden">
                <h3 class="text-xl font-bold mb-4">Tutoriais Obrigatórios</h3>
                <p id="tutorial-question" class="mb-4"></p>
                <div class="flex justify-end gap-2">
                    <button id="no-tutorial-btn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Não</button>
                    <button id="yes-tutorial-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Sim</button>
                </div>
            </div>

            <div id="equipment-step" class="hidden">
                <h3 class="text-xl font-bold mb-4">Aluguel de Equipamentos</h3>
                <p class="mb-4">O Doutor vai precisar de algum equipamento?</p>
                <div class="flex justify-end gap-2">
                    <button id="no-equipment-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Não</button>
                    <button id="yes-equipment-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Sim</button>
                </div>
            </div>

            <div id="garage-step" class="hidden">
                <h3 class="text-xl font-bold mb-4">Reserva de Garagem</h3>
                <p class="mb-4">O Doutor vai precisar de uma vaga de garagem?</p>
                <div class="flex justify-end gap-2">
                    <button id="no-garage-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Não</button>
                    <button id="yes-garage-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Sim</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('confirmation-modal');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const tutorialStep = document.getElementById('tutorial-step');
        const equipmentStep = document.getElementById('equipment-step');
        const garageStep = document.getElementById('garage-step');
        const tutorialQuestion = document.getElementById('tutorial-question');
        const yesTutorialBtn = document.getElementById('yes-tutorial-btn');
        const noTutorialBtn = document.getElementById('no-tutorial-btn');
        
        let reservationData = {};
        const tutorialQuestions = ["Autoclave", "plastificadora", "bomba de vácuo", "raio x"];
        let currentQuestionIndex = 0;

        function showConfirmationModal(roomName, timeSlot, roomId, date) {
            reservationData = { roomName, timeSlot, roomId, date };
            document.getElementById('room-name').textContent = roomName;
            document.getElementById('time-slot').textContent = timeSlot;
            modal.classList.remove('hidden');
            currentQuestionIndex = 0;
            document.getElementById('step-1').classList.remove('hidden');
            tutorialStep.classList.add('hidden');
            equipmentStep.classList.add('hidden');
            garageStep.classList.add('hidden');
        }

        function showTutorialQuestion() {
            if (currentQuestionIndex < tutorialQuestions.length) {
                const equipment = tutorialQuestions[currentQuestionIndex];
                tutorialQuestion.textContent = `O Doutor sabe utilizar ${equipment}?`;
                document.getElementById('step-1').classList.add('hidden');
                tutorialStep.classList.remove('hidden');
            } else {
                showNextStep('equipment');
            }
        }
        
        function showNextStep(step) {
            document.getElementById('step-1').classList.add('hidden');
            tutorialStep.classList.add('hidden');
            equipmentStep.classList.add('hidden');
            garageStep.classList.add('hidden');

            if (step === 'equipment') {
                equipmentStep.classList.remove('hidden');
            } else if (step === 'garage') {
                garageStep.classList.remove('hidden');
            } else {
                // Fim do fluxo, fechar modal
                modal.classList.add('hidden');
                alert("Reserva concluída! Redirecionando...");
            }
        }

        // Ação do Botão de Confirmação, agora com chamada de API
        confirmBtn.addEventListener('click', async () => {
            // Enviar os dados da pré-reserva para o backend
            const response = await fetch('/api/lock_slot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Se você estiver usando CSRF protection, adicione o token aqui
                },
                body: JSON.stringify({
                    room_id: reservationData.roomId,
                    start_time: reservationData.timeSlot,
                    date: reservationData.date,
                    user_id: '{{ current_user.id }}' // Exemplo com Flask-Login
                })
            });

            const result = await response.json();

            if (result.success) {
                // Se o backend travou o horário com sucesso, continue o fluxo
                // Salvando o ID da pré-reserva para uso posterior
                reservationData.reservationId = result.reservation_id;
                showTutorialQuestion();
            } else {
                // Se o backend retornou um erro (horário já ocupado)
                alert(result.message);
                modal.classList.add('hidden'); // Fecha o modal e recarrega a página se necessário
            }
        });

        // Event Listeners
        cancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            // Se houver uma pré-reserva, você pode querer enviá-la para o backend para ser cancelada
        });

        noTutorialBtn.addEventListener('click', () => {
            const equipment = tutorialQuestions[currentQuestionIndex];
            alert(`Redirecionando para o tutorial de ${equipment}.`);
            modal.classList.add('hidden');
        });
        
        yesTutorialBtn.addEventListener('click', () => {
            // Lógica de salvamento de preferência...
            currentQuestionIndex++;
            showTutorialQuestion();
        });
        
        document.getElementById('yes-equipment-btn').addEventListener('click', () => {
            alert("Redirecionando para aluguel de equipamentos em um pop-up menor.");
            // O código para abrir um pop-up menor com a lista de equipamentos viria aqui.
        });
        
        document.getElementById('no-equipment-btn').addEventListener('click', () => {
            showNextStep('garage');
        });

        document.getElementById('yes-garage-btn').addEventListener('click', () => {
            alert("Redirecionando para a tela de vaga de garagem.");
            // Lógica de redirecionamento real para a tela de garagem
            modal.classList.add('hidden');
        });
        
        document.getElementById('no-garage-btn').addEventListener('click', () => {
            showNextStep('end');
        });
    </script>
</body>
</html>
{% endblock %}
